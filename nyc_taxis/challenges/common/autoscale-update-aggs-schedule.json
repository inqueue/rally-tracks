{
  "name": "delete-index",
  "operation": {
    "operation-type": "delete-index"
  }
},
{
  "name": "create-index",
  "operation": {
    "operation-type": "create-index",
    "settings": {%- if index_settings is defined %} {{index_settings | tojson}} {%- else %} {
      "index.store.type": "{{store_type | default('fs')}}",
      "index.codec": "best_compression"
    }{%- endif %}
  }
},
{
  "name": "check-cluster-health",
  "operation": {
    "operation-type": "cluster-health",
    "index": "nyc_taxis",
    "request-params": {
      "wait_for_status": "{{cluster_health | default('green')}}"
    },
    "retry-until-success": true
  }
},
{
  "name": "bulk-preload-25p",
  "clients": {{as_bulk_clients_base | default(8)}},
  "operation": {
    "operation-type": "bulk",
    "bulk-size": {{bulk_size | default(10000)}},
    "ingest-percentage": 25,
    "details-results": false
  }
}
{%- set p_as_bulk_step_count = as_bulk_step_count | default(3) %}
{%- set p_as_bulk_clients_base = as_bulk_clients_base | default(8) %}
{%- set p_as_reduce_factor = as_reduce_factor | default(3) %}
{%- set p_ingest_percentage = ingest_percentage | default(100) %}
{%- for step in range(1, p_as_bulk_step_count + 1, 1) %},
    {%- if step % p_as_reduce_factor == 0 %}
        {%- set task_label = "reduced" %}
        {%- set total_clients = p_as_bulk_clients_base + p_as_bulk_clients_base * 0.5 %}
        {%- set bulk_clients = p_as_bulk_clients_base %}
        {%- set p_ingest_percentage = p_ingest_percentage * 0.5 %}
    {%- else %}
        {%- set task_label = "full" %}
        {%- set total_clients = (p_as_bulk_clients_base + p_as_bulk_clients_base * 0.5) * step %}
        {%- set bulk_clients = p_as_bulk_clients_base * step %}
    {%- endif %}
{
  "parallel": {
    "completed-by": "update-{{step}}-{{bulk_clients}}clients-{{task_label}}",
    "clients": {{total_clients|int}},
    "tasks": [
      {
        "name": "update-{{step}}-{{bulk_clients}}clients-{{task_label}}",
        "clients": {{bulk_clients}},
        "time-period": 500,
        "ignore-response-error-level": "{{error_level | default('non-fatal')}}",
        "operation": {
          "operation-type": "bulk",
          "bulk-size": {{bulk_size | default(10000)}},
          "ingest-percentage": {{p_ingest_percentage|int}},
          "conflicts": "{{conflicts | default('random')}}",
          "on-conflict": "{{on_conflict | default('update')}}",
          "conflict-probability": {{conflict_probability | default(25)}},
          "recency": {{recency | default(0)}},
          "detailed-results": {{detailed_results | default(false) | tojson}}
        }
      },
      {
        "name": "date_histogram_calendar_interval-{{step}}-{{task_label}}",
        "time-period": 7200,
        "target-throughput": 50,
        "operation-type": "search",
        "body": {
          "size": 0,
          "query": {
            "range": {
              "dropoff_datetime": {
                "gte": "2015-01-01 00:00:00",
                "lt": "2015-03-01 00:00:00"
              }
            }
          },
          "aggs": {
            "dropoffs_over_time": {
              "date_histogram": {
                "field": "dropoff_datetime",
                "calendar_interval": "week"
              }
            }
          }
        }
      }
    ]
  }
}
{%- endfor %}
